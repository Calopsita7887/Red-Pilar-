<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteo Red Pilar</title>
    <link id="theme-stylesheet" rel="stylesheet" href="">
    <style>
        /* --- ESTILOS GENERALES (COMPARTIDOS) --- */
        body {
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        .logo-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo {
            width: 150px;
            height: auto;
            filter: invert(1);
        }
        h1 {
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: calc(100% - 22px);
            padding: 10px;
            border-radius: 4px;
            font-size: 16px;
        }
        #numbers-container {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            max-height: 250px;
            overflow-y: auto;
        }
        .number-box {
            text-align: center;
            padding: 8px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: bold;
        }
        .number-box.selected {
            transform: scale(1.05);
        }
        .number-box.assigned {
            text-decoration: line-through;
            cursor: not-allowed;
        }
        .button-group, .add-numbers-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .add-numbers-group {
            margin-top: 10px;
        }
        .range-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        button {
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            flex-grow: 1;
            margin: 0 5px;
            font-weight: bold;
        }
        button:first-child { margin-left: 0; }
        button:last-child { margin-right: 0; }
        #results-container {
            margin-top: 30px;
            padding: 15px;
            border-radius: 8px;
        }
        .person-entry {
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .person-entry:last-child {
            border-bottom: none;
        }
        .person-info {
            flex-grow: 1;
        }
        .person-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .person-numbers {
            font-size: 14px;
            line-height: 1.8;
        }
        .participant-number-tag {
            display: inline-block;
            padding: 2px 8px;
            margin: 2px;
            border-radius: 4px;
            background-color: #3a3a3a;
            border: 1px solid #555;
            font-weight: bold;
        }
        .delete-number-icon {
            cursor: pointer;
            margin-left: 4px;
            font-size: 1em;
            display: inline-block;
            transition: transform 0.1s, color 0.1s;
            vertical-align: middle;
        }
        .delete-number-icon:hover {
            transform: scale(1.3);
            color: #ff8a80;
        }
        .person-entry.is-editing {
            background-color: rgba(255, 255, 150, 0.15);
            border-radius: 4px;
            padding-left: 10px;
            padding-right: 10px;
        }
        .person-actions {
            margin-left: 10px;
        }
        .action-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            margin-left: 5px;
        }
        .person-entry.highlight {
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }
        #ganador-container {
            margin-top: 20px;
            text-align: center;
            position: relative;
        }
        #animation-container {
            position: relative;
            height: 150px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .animated-number {
            position: absolute;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            border-radius: 50%;
            animation-name: shuffle, spin;
            animation-duration: 0.5s, 1s;
            animation-iteration-count: infinite, infinite;
            animation-timing-function: linear, linear;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes shuffle {
            0% { top: 50px; left: 50px; }
            25% { top: 0px; left: 200px; }
            50% { top: 100px; left: 100px; }
            75% { top: 50px; left: 0px; }
            100% { top: 50px; left: 250px; }
        }
        #ganador-nombre, #ganador-numero {
            font-size: 2em;
            font-weight: bold;
            min-height: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ganador-zoom {
            animation: winnerAnimation 2s ease-in-out;
        }
        @keyframes winnerAnimation {
            0% { transform: scale(0.1) rotate(-360deg); opacity: 0; text-shadow: 0 0 2px #fff; }
            25% { color: #ff0; text-shadow: 0 0 10px #ff0; }
            50% { transform: scale(1.5) rotate(15deg); opacity: 1; color: #0f0; text-shadow: 0 0 20px #0f0; }
            75% { transform: scale(0.9) rotate(-10deg); color: #f0f; text-shadow: 0 0 15px #f0f; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; text-shadow: none; }
        }
        .winner-background-flash {
            animation: backgroundFlash 0.5s 4;
        }
        @keyframes backgroundFlash {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(255, 255, 0, 0.3); }
        }
        #countdown-timer {
            font-size: 3em;
            font-weight: bold;
            margin-top: 20px;
        }
        .confetti {
            width: 10px;
            height: 10px;
            background-color: #f06;
            position: absolute;
            top: -10px;
            border-radius: 50%;
            z-index: 1;
            animation-name: fall;
            animation-timing-function: linear;
            animation-fill-mode: forwards;
        }
        @keyframes fall {
            to {
                top: 105%;
                transform: translate(-50%, 0) rotateZ(360deg);
                opacity: 0;
            }
        }
        .number-box.resaltado {
            border: 3px solid #ff5722;
            transform: scale(1.1);
        }
        .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9em;
        }
        #matrix-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        /* --- RESPONSIVE DESIGN --- */
        @media (min-width: 768px) {
            .container {
                max-width: 900px;
            }
            #numbers-container {
                grid-template-columns: repeat(15, 1fr);
            }
        }
        /* --- ESTILOS PARA EL MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .modal-content h3 {
            margin-top: 0;
        }
        .modal-content .form-group {
            margin-bottom: 20px;
        }
        .modal-content select {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            font-size: 16px;
        }
        .modal-content .button-group {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        .modal-content .button-group button {
            width: auto;
            flex-grow: 0;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <canvas id="matrix-canvas"></canvas>
    <div class="container">
        <div class="logo-container">
            <img src="logo.png" alt="Logo de CeluApuestas" class="logo">
        </div>
        <h1 id="main-title">Sorteo Red Pilar</h1>
        <div class="form-group" style="text-align: center; margin-bottom: 20px;">
            <label for="theme-selector" style="display: inline-block; margin-right: 10px;">Tema:</label>
            <select id="theme-selector" style="padding: 5px; border: 1px solid #0f0; background-color: #000; color: #0f0; border-radius: 4px;">
                <option value="hacker">Matrix</option>
                <option value="shooting-stars">Estrellas Fugaces</option>
                <option value="usa-style">Estilo USA</option>
            </select>
        </div>
        <div id="form-container">
            <div class="form-group">
                <label for="person-name">Nombre del Participante:</label>
                <input type="text" id="person-name" placeholder="Escribe el nombre aquí">
            </div>
            <div class="form-group">
                <label>Selecciona los números:</label>
                <div id="numbers-container"></div>
            </div>
            <div class="add-numbers-group">
                <button id="add-10-button">+10</button>
                <button id="add-25-button">+25</button>
                <button id="add-50-button">+50</button>
            </div>
            <div class="range-controls">
                <button id="add-range-button">+10 Números</button>
                <button id="remove-range-button">-10 Números</button>
            </div>
            <div class="button-group">
                <button id="add-button">Añadir Participante</button>
                <button id="clear-button">Limpiar Selección</button>
            </div>
        </div>
        
        <div id="results-container">
            <h2>Participantes</h2>
            <div class="form-group">
                <label for="search-input">Buscar por número:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="search-input" placeholder="Introduce un número">
                    <button id="search-button">Buscar</button>
                    <button id="clear-search-button">Limpiar</button>
                </div>
            </div>
            <div id="participants-list"></div>
        </div>
        
        <div class="button-group">
            <button id="sorteo-button">Realizar Sorteo</button>
            <button id="save-data-button">Guardar Datos</button>
            <button id="load-data-button">Cargar Datos</button>
        </div>

        <div id="save-code-container" style="display: none; margin-top: 15px;">
            <h4>Código de guardado:</h4>
            <p id="saved-code" style="word-break: break-all; background: #222; padding: 10px; border-radius: 4px;"></p>
        </div>
        
        <div id="ganador-container">
            <h2>🎉 Ganador del Sorteo 🎉</h2>
            <div id="animation-container"></div>
            <div id="ganador-numero"></div>
            <div id="ganador-nombre"></div>
            <div id="countdown-timer"></div>
        </div>
        
        <p class="footer">
            <a href="https://www.celuapuestas.ink" target="_blank" style="color: #0f0;">CELUAPUESTAS</a> - RED PILAR - design by Clau Admin Calopsita
        </p>
    </div>

    <!-- Modal para gestionar número libre -->
    <div id="free-number-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="modal-title">Gestionar Número #<span id="modal-number"></span></h3>
            <div class="form-group">
                <label for="assign-to-participant-select">Asignar a un participante existente:</label>
                <select id="assign-to-participant-select">
                    <!-- Opciones se llenarán con JS -->
                </select>
            </div>
            <div class="button-group">
                <button id="modal-assign-button">Asignar</button>
                <button id="modal-cancel-button">Cancelar</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.20.0/matter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script>
        const personNameInput = document.getElementById('person-name');
        const numbersContainer = document.getElementById('numbers-container');
        const addButton = document.getElementById('add-button');
        const clearButton = document.getElementById('clear-button');
        const sorteoButton = document.getElementById('sorteo-button');
        const participantsList = document.getElementById('participants-list');
        const ganadorNombre = document.getElementById('ganador-nombre');
        const ganadorNumero = document.getElementById('ganador-numero');
        const countdownTimer = document.getElementById('countdown-timer');
        const animationContainer = document.getElementById('animation-container');
        const add10Button = document.getElementById('add-10-button');
        const add25Button = document.getElementById('add-25-button');
        const add50Button = document.getElementById('add-50-button');
        const addRangeButton = document.getElementById('add-range-button');
        const removeRangeButton = document.getElementById('remove-range-button');
        const saveDataButton = document.getElementById('save-data-button');
        const loadDataButton = document.getElementById('load-data-button');
        const savedCodeSpan = document.getElementById('saved-code');

        // Search Elements
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const clearSearchButton = document.getElementById('clear-search-button');
        
        // Modal Elements
        const freeNumberModal = document.getElementById('free-number-modal');
        const modalNumberSpan = document.getElementById('modal-number');
        const assignToParticipantSelect = document.getElementById('assign-to-participant-select');
        const modalAssignButton = document.getElementById('modal-assign-button');
        const modalCancelButton = document.getElementById('modal-cancel-button');

        let currentNumberInModal = null;
        let allNumbers = [];
        let assignedNumbers = new Set();
        let selectedNumbers = new Set();
        let participants = [];
        
        let isEditing = false;
        let editingIndex = -1;
        let isLoading = false;

        // --- Lógica del Sorteo ---
        function generateNumbers(count = 100) {
            allNumbers = Array.from({ length: count }, (_, i) => i + 1);
            renderNumbers();
        }

        function addMoreNumbers(count) {
            const currentMax = allNumbers.length > 0 ? allNumbers[allNumbers.length - 1] : 0;
            for (let i = 1; i <= count; i++) {
                allNumbers.push(currentMax + i);
            }
            renderNumbers();
            saveToLocalStorage();
        }

        function removeNumbers(count) {
            if (allNumbers.length <= 10) {
                alert("No se pueden eliminar más números. Debe haber al menos 10 números disponibles.");
                return;
            }
            
            const numbersToRemove = allNumbers.slice(-count);
            const hasAssignedNumbers = numbersToRemove.some(num => assignedNumbers.has(num));
            
            if (hasAssignedNumbers) {
                alert("No se pueden eliminar números que ya están asignados a participantes.");
                return;
            }
            
            allNumbers = allNumbers.slice(0, -count);
            renderNumbers();
            saveToLocalStorage();
        }

        function openFreeNumberModal(number) {
            currentNumberInModal = number;
            modalNumberSpan.textContent = number;
            populateParticipantsDropdown();
            freeNumberModal.style.display = 'flex';
        }

        function closeFreeNumberModal() {
            currentNumberInModal = null;
            freeNumberModal.style.display = 'none';
        }

        function populateParticipantsDropdown() {
            assignToParticipantSelect.innerHTML = '';

            if (participants.length === 0) {
                const option = document.createElement('option');
                option.textContent = 'No hay participantes todavía';
                option.disabled = true;
                assignToParticipantSelect.appendChild(option);
                modalAssignButton.disabled = true;
            } else {
                const placeholder = document.createElement('option');
                placeholder.textContent = 'Selecciona un participante...';
                placeholder.value = '';
                assignToParticipantSelect.appendChild(placeholder);

                participants.forEach((person, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = person.name;
                    assignToParticipantSelect.appendChild(option);
                });
                modalAssignButton.disabled = false;
            }
        }

        function assignNumberToParticipant() {
            const selectedParticipantIndex = assignToParticipantSelect.value;

            if (selectedParticipantIndex === '' || currentNumberInModal === null) {
                alert('Por favor, selecciona un participante.');
                return;
            }

            const participant = participants[selectedParticipantIndex];
            const numberToAssign = currentNumberInModal;

            participant.numbers.push(numberToAssign);
            participant.numbers.sort((a, b) => a - b);
            assignedNumbers.add(numberToAssign);

            renderNumbers();
            renderParticipants();
            saveToLocalStorage();
            closeFreeNumberModal();

            alert(`El número ${numberToAssign} ha sido asignado a ${participant.name}.`);
        }

        function renderNumbers() {
            numbersContainer.innerHTML = '';
            allNumbers.forEach(num => {
                const numberBox = document.createElement('div');
                numberBox.classList.add('number-box');
                numberBox.textContent = num;
                numberBox.dataset.number = num;

                if (assignedNumbers.has(num)) {
                    numberBox.classList.add('assigned');
                }
                if (selectedNumbers.has(num)) {
                    numberBox.classList.add('selected');
                }

                numberBox.addEventListener('click', () => {
                    if (assignedNumbers.has(num)) {
                        return;
                    }

                    const isAddingParticipant = personNameInput.value.trim() !== '';

                    if (isAddingParticipant) {
                        if (selectedNumbers.has(num)) {
                            selectedNumbers.delete(num);
                            numberBox.classList.remove('selected');
                        } else {
                            selectedNumbers.add(num);
                            numberBox.classList.add('selected');
                        }
                    } else {
                        if (selectedNumbers.has(num)) {
                            selectedNumbers.delete(num);
                            numberBox.classList.remove('selected');
                        }
                        openFreeNumberModal(num);
                    }
                });
                numbersContainer.appendChild(numberBox);
            });
        }

        function addParticipant() {
            const name = personNameInput.value.trim();
            if (name === '') {
                alert('Por favor, introduce un nombre.');
                return;
            }

            selectedNumbers.clear();
            const selectedBoxes = numbersContainer.querySelectorAll('.number-box.selected');
            selectedBoxes.forEach(box => {
                selectedNumbers.add(parseInt(box.dataset.number, 10));
            });

            if (selectedNumbers.size === 0) {
                alert('Por favor, selecciona al menos un número.');
                return;
            }

            const newParticipant = {
                name: name,
                numbers: Array.from(selectedNumbers).sort((a, b) => a - b)
            };

            if (isEditing) {
                const oldNumbers = participants[editingIndex].numbers;
                oldNumbers.forEach(num => assignedNumbers.delete(num));
                participants[editingIndex] = newParticipant;
                isEditing = false;
                editingIndex = -1;
                addButton.textContent = 'Añadir Participante';
            } else {
                participants.push(newParticipant);
            }

            selectedNumbers.forEach(num => assignedNumbers.add(num));
            
            personNameInput.value = '';
            selectedNumbers.clear();
            
            renderNumbers();
            renderParticipants();
            saveToLocalStorage();
        }

        function renderParticipants() {
            participantsList.innerHTML = '';
            participants.forEach((person, index) => {
                const personEntry = document.createElement('div');
                personEntry.classList.add('person-entry');

                const isCurrentlyEditing = isEditing && editingIndex === index;
                if (isCurrentlyEditing) {
                    personEntry.classList.add('is-editing');
                }

                const personInfo = document.createElement('div');
                personInfo.classList.add('person-info');

                const numbersHTML = person.numbers.map(num => {
                    const isCurrentlyEditing = isEditing && editingIndex === index;
                    const deleteIconHTML = isCurrentlyEditing
                        ? `<span class="delete-number-icon" title="Eliminar número" onclick="deleteNumberFromParticipant(${index}, ${num})">🗑️</span>`
                        : '';

                    return `<span class="participant-number-tag">${num}${deleteIconHTML}</span>`;
                }).join(' ');

                personInfo.innerHTML = `
                    <div class="person-name">${person.name}</div>
                    <div class="person-numbers">Números: ${numbersHTML}</div>
                `;
                personEntry.appendChild(personInfo);

                const personActions = document.createElement('div');
                personActions.classList.add('person-actions');
                
                const editButton = document.createElement('button');
                editButton.innerHTML = '✏️';
                editButton.classList.add('action-button');
                editButton.title = 'Editar';
                editButton.addEventListener('click', () => editParticipant(index));
                personActions.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '🗑️';
                deleteButton.classList.add('action-button');
                deleteButton.title = 'Eliminar Participante';
                deleteButton.addEventListener('click', () => deleteParticipant(index));
                personActions.appendChild(deleteButton);

                personEntry.appendChild(personActions);
                participantsList.appendChild(personEntry);
            });
        }

        function editParticipant(index) {
            const personToEdit = participants[index];
            personNameInput.value = personToEdit.name;
            selectedNumbers.clear();
            personToEdit.numbers.forEach(num => selectedNumbers.add(num));
            renderNumbers();
            
            isEditing = true;
            editingIndex = index;
            addButton.textContent = 'Actualizar Participante';
            renderParticipants(); // Re-render to show delete icons
        }

        function deleteParticipant(index) {
            if (confirm('¿Estás seguro de que quieres eliminar a este participante?')) {
                const personToDelete = participants[index];
                personToDelete.numbers.forEach(num => assignedNumbers.delete(num));
                participants.splice(index, 1);
                
                renderNumbers();
                renderParticipants();
                saveToLocalStorage();
            }
        }

        function deleteNumberFromParticipant(participantIndex, numberToDelete) {
            const participant = participants[participantIndex];

            const numberIndex = participant.numbers.indexOf(numberToDelete);
            if (numberIndex > -1) {
                participant.numbers.splice(numberIndex, 1);
            }

            assignedNumbers.delete(numberToDelete);

            if (participant.numbers.length === 0) {
                if (confirm(`El participante ${participant.name} ya no tiene números. ¿Deseas eliminarlo de la lista?`)) {
                    participants.splice(participantIndex, 1);
                }
            }

            renderNumbers();
            renderParticipants();
            saveToLocalStorage();
        }

        function clearSelection() {
            selectedNumbers.clear();
            renderNumbers();
        }

        function selectRange(count) {
            selectedNumbers.clear();
            const unassignedNumbers = allNumbers.filter(num => !assignedNumbers.has(num));
            for (let i = 0; i < Math.min(count, unassignedNumbers.length); i++) {
                selectedNumbers.add(unassignedNumbers[i]);
            }
            renderNumbers();
        }

        async function realizarSorteo() {
            if (participants.length === 0) {
                alert('No hay participantes para el sorteo.');
                return;
            }
            
            const allAssignedNumbers = Array.from(assignedNumbers);
            if (allAssignedNumbers.length === 0) {
                alert('No hay números asignados para sortear.');
                return;
            }

            sorteoButton.disabled = true;
            clearButton.disabled = true;

            ganadorNombre.textContent = '';
            ganadorNumero.textContent = '';
            countdownTimer.style.display = 'block';

            let countdown = 3;
            const countdownInterval = setInterval(() => {
                countdownTimer.textContent = countdown;
                if (countdown === 0) {
                    clearInterval(countdownInterval);
                    countdownTimer.style.display = 'none';
                    startAnimation(allAssignedNumbers);
                }
                countdown--;
            }, 1000);
        }

        function startAnimation(numbersPool) {
            animationContainer.innerHTML = ''; // Clear previous animations

            const finalWinnerNumber = numbersPool[Math.floor(Math.random() * numbersPool.length)];
            const animationDuration = 7000; // 7 seconds
            const containerWidth = animationContainer.offsetWidth;
            const containerHeight = animationContainer.offsetHeight;

            // module aliases
            var Engine = Matter.Engine,
                Render = Matter.Render,
                Runner = Matter.Runner,
                Events = Matter.Events,
                Body = Matter.Body,
                Bodies = Matter.Bodies,
                Composite = Matter.Composite;

            // create an engine
            var engine = Engine.create();
            engine.world.gravity.y = 0; // No gravity

            // create a renderer
            var render = Render.create({
                element: animationContainer,
                engine: engine,
                options: {
                    width: containerWidth,
                    height: containerHeight,
                    wireframes: false, // We want to see the colors
                    background: 'transparent'
                }
            });

            // Create boundaries
            const wallOptions = { isStatic: true, render: { visible: false } };
            Composite.add(engine.world, [
                Bodies.rectangle(containerWidth / 2, 5, containerWidth, 10, wallOptions), // Top
                Bodies.rectangle(containerWidth / 2, containerHeight - 5, containerWidth, 10, wallOptions), // Bottom
                Bodies.rectangle(5, containerHeight / 2, 10, containerHeight, wallOptions), // Left
                Bodies.rectangle(containerWidth - 5, containerHeight / 2, 10, containerHeight, wallOptions) // Right
            ]);

            function getRandomColor() {
                const colors = ['#FF5733', '#33FF57', '#3357FF', '#FF33A1', '#A133FF', '#FFFF33'];
                return colors[Math.floor(Math.random() * colors.length)];
            }

            // Helper function to create a texture with the number
            function createBallTexture(number, color) {
                const canvas = document.createElement('canvas');
                canvas.width = 50;
                canvas.height = 50;
                const context = canvas.getContext('2d');
                context.beginPath();
                context.arc(25, 25, 25, 0, 2 * Math.PI);
                context.fillStyle = color;
                context.fill();
                context.fillStyle = '#000'; // Black text
                context.font = 'bold 24px "Courier New"';
                context.textAlign = 'center';
                context.textBaseline = 'middle';
                context.fillText(number, 25, 25);
                return canvas.toDataURL();
            }

            // Create balls
            const balls = [];
            const numBalls = Math.min(numbersPool.length, 50); // Increased from 30 to 50
            let usedNumbers = new Set();

            for (let i = 0; i < numBalls; i++) {
                let number;
                do {
                    number = numbersPool[Math.floor(Math.random() * numbersPool.length)];
                } while (usedNumbers.has(number));
                usedNumbers.add(number);

                const ball = Bodies.circle(
                    Math.random() * (containerWidth - 60) + 30, // x
                    Math.random() * (containerHeight - 60) + 30, // y
                    25, // radius
                    {
                        restitution: 1, // bounciness
                        friction: 0,
                        frictionAir: 0,
                        render: {
                            sprite: {
                                texture: createBallTexture(number, getRandomColor()),
                                xScale: 1,
                                yScale: 1
                            }
                        }
                    }
                );
                // Give it a random initial velocity
                Body.setVelocity(ball, {
                    x: (Math.random() - 0.5) * 15,
                    y: (Math.random() - 0.5) * 15
                });
                balls.push(ball);
            }

            Composite.add(engine.world, balls);

            // Keep balls moving
            Events.on(engine, 'beforeUpdate', function(event) {
                for (var i = 0; i < balls.length; i++) {
                    var ball = balls[i];
                    // Apply a small random force
                    Body.applyForce(ball, ball.position, {
                        x: (Math.random() - 0.5) * 0.001,
                        y: (Math.random() - 0.5) * 0.001
                    });
                }
            });

            // run the renderer
            Render.run(render);

            // create runner
            var runner = Runner.create();

            // run the engine
            Runner.run(runner, engine);

            setTimeout(() => {
                // Stop the simulation
                Runner.stop(runner);
                Render.stop(render);
                Composite.clear(engine.world, false);
                Engine.clear(engine);
                if (render.canvas) {
                    render.canvas.remove();
                }

                showWinner(finalWinnerNumber);
            }, animationDuration);
        }

        function showWinner(winnerNumber) {
            const winner = participants.find(p => p.numbers.includes(winnerNumber));
            const winningPersonName = winner ? winner.name : 'Desconocido';

            ganadorNombre.textContent = winningPersonName;
            ganadorNumero.textContent = winnerNumber;
            
            ganadorNombre.classList.add('ganador-zoom');
            ganadorNumero.classList.add('ganador-zoom');
            document.querySelector('.container').classList.add('winner-background-flash');


            setTimeout(() => {
                ganadorNombre.classList.remove('ganador-zoom');
                ganadorNumero.classList.remove('ganador-zoom');
                document.querySelector('.container').classList.remove('winner-background-flash');
            }, 2000);

            const winningNumberBox = document.querySelector(`.number-box[data-number="${winnerNumber}"]`);
            if (winningNumberBox) {
                winningNumberBox.classList.add('resaltado');
            }

            createConfetti();

            sorteoButton.disabled = false;
            clearButton.disabled = false;
            saveToLocalStorage();
        }

        function createConfetti() {
            const container = document.querySelector('.container');
            for (let i = 0; i < 200; i++) { // Increased from 50 to 200
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
                container.appendChild(confetti);

                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        }

        // --- Lógica de Búsqueda ---
        function clearHighlight() {
            const highlighted = participantsList.querySelector('.person-entry.highlight');
            if (highlighted) {
                highlighted.classList.remove('highlight');
            }
        }

        function searchByNumber() {
            clearHighlight();
            const numberToFind = parseInt(searchInput.value.trim(), 10);

            if (isNaN(numberToFind)) {
                if (searchInput.value.trim() !== '') {
                    alert('Por favor, introduce un número válido.');
                }
                return;
            }

            let foundParticipantIndex = -1;
            for (let i = 0; i < participants.length; i++) {
                if (participants[i].numbers.includes(numberToFind)) {
                    foundParticipantIndex = i;
                    break;
                }
            }

            if (foundParticipantIndex !== -1) {
                const participantElements = participantsList.querySelectorAll('.person-entry');
                const participantElement = participantElements[foundParticipantIndex];
                if (participantElement) {
                    participantElement.classList.add('highlight');
                    participantElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } else {
                alert(`El número ${numberToFind} no está asignado a ningún participante.`);
            }
        }

        function clearSearch() {
            clearHighlight();
            searchInput.value = '';
        }

        // --- Funcionalidad de Guardado y Carga ---
        function saveToLocalStorage() {
            const data = {
                participants: participants,
                assignedNumbers: Array.from(assignedNumbers),
                allNumbers: allNumbers
            };
            const compressedData = btoa(JSON.stringify(data));
            localStorage.setItem('raffleData', compressedData);
        }

        function loadFromLocalStorage() {
            const compressedData = localStorage.getItem('raffleData');
            if (compressedData) {
                try {
                    const decompressedData = JSON.parse(atob(compressedData));
                    participants = decompressedData.participants || [];
                    assignedNumbers = new Set(decompressedData.assignedNumbers || []);
                    allNumbers = decompressedData.allNumbers || [];

                    if (allNumbers.length === 0) {
                        generateNumbers(100);
                    } else {
                        renderNumbers();
                    }
                    renderParticipants();

                } catch (e) {
                    console.error("Error al analizar los datos de localStorage, reseteando. Error:", e);
                    localStorage.removeItem('raffleData');
                    generateNumbers(100);
                }
            } else {
                generateNumbers(100);
            }
        }

        function getSaveDataString() {
             const data = {
                allNumbersCount: allNumbers.length,
                participants: participants
            };
            return JSON.stringify(data);
        }

        function generateSaveCode() {
            if (typeof pako === 'undefined') {
                alert("La librería de compresión no se ha cargado. Por favor, revisa tu conexión a internet y refresca la página.");
                return;
            }
            const dataString = getSaveDataString();
            const compressed = pako.deflate(dataString, { to: 'string' });
            const encoded = btoa(compressed);
            savedCodeSpan.textContent = encoded;
            document.getElementById('save-code-container').style.display = 'block';
        }

        function loadFromCode() {
             if (typeof pako === 'undefined') {
                alert("La librería de compresión no se ha cargado. Por favor, revisa tu conexión a internet y refresca la página.");
                return;
            }
            const code = prompt('Introduce el código de guardado:');
            if (code && code.trim() !== '') {
                try {
                    const decoded = atob(code);
                    const decompressed = pako.inflate(decoded, { to: 'string' });
                    const data = JSON.parse(decompressed);

                    if (!data.allNumbersCount || !data.participants) throw new Error("Datos corruptos o en formato incorrecto.");

                    allNumbers = Array.from({ length: data.allNumbersCount }, (_, i) => i + 1);
                    participants = data.participants;
                    assignedNumbers.clear();
                    participants.forEach(p => {
                        p.numbers.forEach(num => assignedNumbers.add(num));
                    });
                    
                    renderNumbers();
                    renderParticipants();
                    saveToLocalStorage();
                    alert('Datos cargados correctamente.');

                } catch (e) {
                    console.error("Error al cargar desde el código:", e);
                    alert(`Código inválido o dañado. ${e.message}`);
                }
            }
        }

        // --- Lógica de Temas y Animaciones ---
        const themeSelector = document.getElementById('theme-selector');
        const themeStylesheet = document.getElementById('theme-stylesheet');
        const matrixCanvas = document.getElementById('matrix-canvas');
        const matrixCtx = matrixCanvas.getContext('2d');
        let animationInterval;
        let currentTheme = 'hacker';

        function applyTheme(themeName) {
            currentTheme = themeName;
            themeStylesheet.setAttribute('href', `${themeName}.css`);
            localStorage.setItem('raffleTheme', themeName);

            if (animationInterval) clearInterval(animationInterval);

            matrixCtx.clearRect(0, 0, matrixCanvas.width, matrixCanvas.height);

            if (themeName === 'hacker') {
                matrixCanvas.style.display = 'block';
                startMatrixAnimation();
            } else if (themeName === 'shooting-stars') {
                matrixCanvas.style.display = 'block';
                startShootingStarsAnimation();
            } else if (themeName === 'usa-style') {
                matrixCanvas.style.display = 'block';
                startUsaStyleAnimation();
            } else {
                matrixCanvas.style.display = 'none';
            }
        }

        function startMatrixAnimation() {
            if (animationInterval) clearInterval(animationInterval);

            matrixCanvas.width = window.innerWidth;
            matrixCanvas.height = window.innerHeight;

            const letters = '0123456789';
            const fontSize = 16;
            const columns = matrixCanvas.width / fontSize;

            const drops = [];
            for (let x = 0; x < columns; x++) {
                drops[x] = 1;
            }

            function drawMatrix() {
                matrixCtx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                matrixCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);

                matrixCtx.fillStyle = '#0f0';
                matrixCtx.font = fontSize + 'px arial';

                for (let i = 0; i < drops.length; i++) {
                    const text = letters.charAt(Math.floor(Math.random() * letters.length));
                    matrixCtx.fillText(text, i * fontSize, drops[i] * fontSize);

                    if (drops[i] * fontSize > matrixCanvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
            }
            animationInterval = setInterval(drawMatrix, 33);
        }

        function startShootingStarsAnimation() {
            if (animationInterval) clearInterval(animationInterval);

            matrixCanvas.width = window.innerWidth;
            matrixCanvas.height = window.innerHeight;
            const ctx = matrixCtx;

            // Static background stars
            const staticStars = [];
            for(let i=0; i<150; i++) {
                staticStars.push({
                    x: Math.random() * matrixCanvas.width,
                    y: Math.random() * matrixCanvas.height,
                    radius: Math.random() * 1.2 + 0.5,
                    opacity: Math.random() * 0.7 + 0.1
                });
            }

            // Shooting stars
            const shootingStars = [];
            const numShootingStars = 15;
            for (let i = 0; i < numShootingStars; i++) {
                shootingStars.push({
                    x: Math.random() * matrixCanvas.width,
                    y: Math.random() * matrixCanvas.height,
                    len: Math.random() * 40 + 20,
                    speed: Math.random() * 2 + 3,
                    opacity: Math.random() * 0.6 + 0.2
                });
            }

            function drawAnimation() {
                // Fading background
                ctx.fillStyle = 'rgba(12, 12, 44, 0.25)';
                ctx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);

                // Draw static stars
                staticStars.forEach(star => {
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                    ctx.fill();
                });

                // Draw and update shooting stars
                shootingStars.forEach(star => {
                    const tailX = star.x - star.len;
                    const tailY = star.y - star.len;

                    const gradient = ctx.createLinearGradient(star.x, star.y, tailX, tailY);
                    gradient.addColorStop(0, `rgba(255, 255, 255, ${star.opacity})`);
                    gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

                    ctx.strokeStyle = gradient;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(star.x, star.y);
                    ctx.lineTo(tailX, tailY);
                    ctx.stroke();

                    // Move the star
                    star.x += star.speed;
                    star.y += star.speed;

                    // Reset star when it goes off-screen
                    if (star.x > matrixCanvas.width + star.len || star.y > matrixCanvas.height + star.len) {
                        star.x = Math.random() * matrixCanvas.width - 300;
                        star.y = Math.random() * matrixCanvas.height - 300;
                        star.len = Math.random() * 40 + 20;
                        star.speed = Math.random() * 2 + 3;
                        star.opacity = Math.random() * 0.6 + 0.2;
                    }
                });
            }

            animationInterval = setInterval(drawAnimation, 20);
        }

        function startUsaStyleAnimation() {
            if (animationInterval) clearInterval(animationInterval);

            matrixCanvas.width = window.innerWidth;
            matrixCanvas.height = window.innerHeight;
            const ctx = matrixCtx;

            const particles = [];
            const numParticles = 100;

            for (let i = 0; i < numParticles; i++) {
                const isStar = Math.random() > 0.3; // 70% chance of being a star
                particles.push({
                    x: Math.random() * matrixCanvas.width,
                    y: Math.random() * matrixCanvas.height,
                    speed: Math.random() * 1 + 0.5,
                    radius: Math.random() * 1.5 + 0.5,
                    color: isStar ? '#FFFFFF' : '#B22234', // White or Old Glory Red
                    isStar: isStar
                });
            }

            function drawUsaAnimation() {
                ctx.fillStyle = 'rgba(60, 59, 110, 0.25)'; // Fading Old Glory Blue
                ctx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);

                particles.forEach(p => {
                    ctx.fillStyle = p.color;
                    ctx.beginPath();

                    if (p.isStar) {
                        // Draw a 5-point star
                        ctx.moveTo(p.x, p.y - p.radius);
                        for (let i = 0; i < 5; i++) {
                            const outerX = p.x + Math.cos((18 + i * 72) * Math.PI / 180) * p.radius;
                            const outerY = p.y - Math.sin((18 + i * 72) * Math.PI / 180) * p.radius;
                            ctx.lineTo(outerX, outerY);
                            const innerX = p.x + Math.cos((54 + i * 72) * Math.PI / 180) * p.radius * 0.5;
                            const innerY = p.y - Math.sin((54 + i * 72) * Math.PI / 180) * p.radius * 0.5;
                            ctx.lineTo(innerX, innerY);
                        }
                        ctx.closePath();
                        ctx.fill();
                    } else {
                        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                        ctx.fill();
                    }

                    // Move particle
                    p.y += p.speed;

                    // Reset particle when it goes off-screen
                    if (p.y > matrixCanvas.height + p.radius) {
                        p.x = Math.random() * matrixCanvas.width;
                        p.y = -p.radius;
                    }
                });
            }

            animationInterval = setInterval(drawUsaAnimation, 33);
        }

        window.addEventListener('resize', () => {
            if (currentTheme === 'hacker') {
                startMatrixAnimation();
            } else if (currentTheme === 'shooting-stars') {
                startShootingStarsAnimation();
            } else if (currentTheme === 'usa-style') {
                startUsaStyleAnimation();
            }
        });

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('raffleTheme') || 'hacker';
            if(themeSelector) {
                themeSelector.value = savedTheme;
            }
            applyTheme(savedTheme);
            loadFromLocalStorage();
        });

        // --- Event Listeners ---
        if(themeSelector) {
            themeSelector.addEventListener('change', (e) => applyTheme(e.target.value));
        }
        addButton.addEventListener('click', addParticipant);
        clearButton.addEventListener('click', clearSelection);
        sorteoButton.addEventListener('click', realizarSorteo);
        add10Button.addEventListener('click', () => selectRange(10));
        add25Button.addEventListener('click', () => selectRange(25));
        add50Button.addEventListener('click', () => selectRange(50));
        addRangeButton.addEventListener('click', () => addMoreNumbers(10));
        removeRangeButton.addEventListener('click', () => removeNumbers(10));
        saveDataButton.addEventListener('click', generateSaveCode);
        loadDataButton.addEventListener('click', loadFromCode);
        modalCancelButton.addEventListener('click', closeFreeNumberModal);
        modalAssignButton.addEventListener('click', assignNumberToParticipant);
        searchButton.addEventListener('click', searchByNumber);
        clearSearchButton.addEventListener('click', clearSearch);
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                searchByNumber();
            }
        });

    </script>
</body>
</html>
